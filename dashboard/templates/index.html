{% extends "base.html" %}
{% block title %}V7.0 SCALING – Polymarket Bot{% endblock %}

{% block body %}
<!-- 2026 V7.0 SCALING: Plotly Dashboard -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
    :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --accent: #bb86fc;
        --text-color: #e0e0e0;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    .card {
        background: var(--card-bg);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        margin-bottom: 20px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    h3 {
        margin-top: 0;
        color: var(--text-color);
        border-bottom: 1px solid #333;
        padding-bottom: 5px;
    }

    .export-btn {
        background: var(--accent);
        color: #000;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 15px;
    }

    .navbar {
        display: flex;
        justify-content: space-between;
        padding: 10px 20px;
        background: var(--card-bg);
        align-items: center;
    }
</style>

<nav class="navbar" style="margin-bottom: 20px;">
    <span class="navbar-brand">Polymarket Bot V7.0</span>
    <!-- 2026 V7.1 FIX KILL SWITCH — bidirectional -->
    <div style="display:flex; align-items:center;">
        <button class="export-btn" style="background:#cf6679; color:#fff; margin-right:10px;"
            onclick="toggleBot('kill')">⏹️ Kill Bot</button>
        <button class="export-btn" style="background:#03dac6; color:#000; margin-right:10px; display:none;"
            id="resume-btn" onclick="toggleBot('resume')">▶️ Resume Bot</button>
        <button class="export-btn" onclick="exportCSV()">Export CSV</button>
        <a href="{{ url_for('logout') }}" style="margin-left:15px; color:var(--accent);">Logout</a>
    </div>
</nav>

<div class="container">
    <!-- 2026 V7.2 LIVE AGGRESSIVITY DASHBOARD CONTROL -->
    <div class="card" style="margin-bottom: 20px;">
        <h3 style="display:flex; justify-content:space-between; align-items:center;">
            <span>Agressivité du Bot</span>
            <span id="agg-indicator" style="font-size:0.9rem; color:#aaa">Chargement...</span>
        </h3>
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <button class="btn"
                style="padding: 8px 16px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; background-color: #4caf50; color: white;"
                onclick="setAggressivity('Conservative')">Conservative</button>
            <button class="btn"
                style="padding: 8px 16px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; background-color: #2196f3; color: white;"
                onclick="setAggressivity('Balanced')">Balanced</button>
            <button class="btn"
                style="padding: 8px 16px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; background-color: #ff9800; color: white;"
                onclick="setAggressivity('Aggressive')">Aggressive</button>
            <button class="btn"
                style="padding: 8px 16px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; background-color: #f44336; color: white;"
                onclick="setAggressivity('Very Aggressive')">Very Aggressive</button>
        </div>
        <div id="agg-status"
            style="padding: 10px; background: #2a2a2a; border-radius: 4px; font-family: monospace; font-size: 0.95rem;">
            ...
        </div>
    </div>
    <div class="grid-2">
        <div class="card">
            <h3>PnL Cumule</h3>
            <div id="pnl-chart"></div>
        </div>
        <div class="card">
            <h3>Performance (OBI vs AI Edge)</h3>
            <div id="perf-chart"></div>
        </div>
    </div>

    <div class="grid-2">
        <div class="card">
            <h3>Positions Live</h3>
            <div id="pos-chart"></div>
        </div>
        <div class="card">
            <h3>Inventory Skew</h3>
            <div id="skew-chart"></div>
        </div>
    </div>
</div>

<script>
    const layoutConfig = {
        paper_bgcolor: '#1e1e1e',
        plot_bgcolor: '#1e1e1e',
        font: { color: '#e0e0e0' },
        margin: { t: 30, r: 20, l: 40, b: 40 }
    };

    let pnlDataCSV = [];

    function renderCharts() {
        // PnL Cumule
        fetch('/api/analytics/cumulative-pnl')
            .then(r => r.json())
            .then(data => {
                const traces = [{
                    x: data.map(d => d.timestamp),
                    y: data.map(d => d.pnl),
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#03dac6', width: 2 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(3,218,198,0.1)'
                }];
                Plotly.newPlot('pnl-chart', traces, layoutConfig);
                pnlDataCSV = data;
            }).catch(e => console.error(e));

        // Positions Live & Inventory Skew
        fetch('/api/v7/metrics')
            .then(r => r.json())
            .then(data => {
                if (data.positions.x && data.positions.x.length > 0) {
                    const tracePos = [{ x: data.positions.x, y: data.positions.y, type: 'bar', marker: { color: '#cf6679' } }];
                    Plotly.newPlot('pos-chart', tracePos, layoutConfig);

                    const traceSkew = [{ labels: data.skews.labels, values: data.skews.values, type: 'pie', textinfo: "label+percent", hole: .4 }];
                    Plotly.newPlot('skew-chart', traceSkew, layoutConfig);
                } else {
                    document.getElementById('pos-chart').innerHTML = '<span style="color:#777">Aucune position active</span>';
                    document.getElementById('skew-chart').innerHTML = '<span style="color:#777">Inventaire vide</span>';
                }
            }).catch(e => console.error(e));

        // OBI vs AI Edge (mock comparatif conceptuel attendu pour V7.0)
        const tracePerf = {
            x: ['Model OBI', 'Model AI Edge'],
            y: [58.4, 63.2], // Win rate typique simulé
            type: 'bar',
            marker: { color: ['#bb86fc', '#03dac6'] }
        };
        Plotly.newPlot('perf-chart', [tracePerf], layoutConfig);
    }

    function exportCSV() {
        let csv = "Timestamp,PnL_USDC\\n";
        pnlDataCSV.forEach(r => { csv += `${r.timestamp},${Math.round(r.pnl * 100) / 100}\\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "Pnl_Export_V7.csv";
        a.click();
    }

    // 2026 V7.1 FIX KILL SWITCH — bidirectional
    function toggleBot(action) {
        fetch('/' + action, { method: 'POST' }).then(() => window.location.reload());
    }
    fetch('/health').then(r => r.json()).then(d => {
        if (d.kill_switch) document.getElementById('resume-btn').style.display = 'inline-block';
    });

    // 2026 V7.2 LIVE AGGRESSIVITY DASHBOARD CONTROL
    function loadAggressivity() {
        fetch('/api/aggressivity')
            .then(r => r.json())
            .then(data => {
                const s = data.params;
                document.getElementById('agg-status').innerHTML =
                    `Niveau Actuel: <strong style="color:var(--accent)">${data.level}</strong><br>` +
                    `<span style="color:#aaa">Max Expo:</span> ${s.max_expo} | ` +
                    `<span style="color:#aaa">Inv Skew:</span> ${s.skew_ask_only} | ` +
                    `<span style="color:#aaa">Sizing Mult:</span> ${s.sizing_mult} | ` +
                    `<span style="color:#aaa">Max Order:</span> $${s.max_order_usd}`;
                document.getElementById('agg-indicator').innerText = data.level;
            }).catch(e => console.error(e));
    }

    function setAggressivity(level) {
        document.getElementById('agg-indicator').innerText = "Mise à jour...";
        fetch('/api/aggressivity', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ level: level })
        }).then(() => loadAggressivity());
    }

    // Call loadAggressivity onload
    loadAggressivity();

    // Refresh Live 30s
    renderCharts();
    setInterval(renderCharts, 30000);
</script>
{% endblock %}