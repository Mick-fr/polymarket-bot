{% extends "base.html" %}
{% block title %}V7.3 ULTIMATE ‚Äì Polymarket Bot{% endblock %}

{% block body %}
<!-- 2026 V7.3 DASHBOARD ULTIME - Ultimate Professional Interface -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
    :root {
        --bg-color: #0d0d0d;
        --card-bg: #1c1c1e;
        --accent: #bb86fc;
        --accent-glow: rgba(187, 134, 252, 0.4);
        --text-color: #e0e0e0;
        --green: #03dac6;
        --red: #cf6679;
        --border: #333;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 1400px;
        padding: 20px;
        margin: auto;
    }

    .card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        margin-bottom: 25px;
        border: 1px solid var(--border);
    }

    .card-title {
        margin-top: 0;
        color: var(--text-color);
        border-bottom: 2px solid var(--border);
        padding-bottom: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.25rem;
    }

    .grid-4 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }

    .stat-box {
        background: rgba(255, 255, 255, 0.03);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #333;
        text-align: center;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin: 10px 0;
    }

    .text-green {
        color: var(--green);
    }

    .text-red {
        color: var(--red);
    }

    .text-accent {
        color: var(--accent);
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }

    .btn-accent {
        background: var(--accent);
        color: #000;
    }

    .btn-red {
        background: var(--red);
        color: #fff;
    }

    .btn-green {
        background: var(--green);
        color: #000;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--accent);
        color: var(--accent);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9rem;
    }

    th,
    td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #333;
    }

    th {
        color: #888;
        font-weight: normal;
        text-transform: uppercase;
        font-size: 0.8rem;
    }

    tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    /* Navbar */
    .navbar {
        display: flex;
        justify-content: space-between;
        padding: 15px 30px;
        background: var(--card-bg);
        align-items: center;
        border-bottom: 1px solid var(--border);
    }

    .navbar-brand {
        font-size: 1.5rem;
        font-weight: bold;
        background: linear-gradient(90deg, var(--accent), var(--green));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .badge-gray {
        background: #333;
        color: #ccc;
    }

    .loading {
        opacity: 0.5;
        pointer-events: none;
    }
</style>

<nav class="navbar">
    <div style="display:flex; align-items:center; gap:20px;">
        <span class="navbar-brand">Polymarket Bot V7.3</span>
        <div id="agg-indicator" class="badge badge-gray">Loading...</div>
    </div>
    <div style="display:flex; align-items:center; gap:12px;">
        <button class="btn btn-red" id="btn-kill" style="display:none;" onclick="toggleBot('kill')">‚èπÔ∏è Kill
            Switch</button>
        <button class="btn btn-green" id="btn-resume" style="display:none;" onclick="toggleBot('resume')">‚ñ∂Ô∏è
            Resume</button>
        <!-- Agressivity Control -->
        <select id="agg-select" class="btn btn-outline" onchange="setAggressivity(this.value)">
            <option value="Conservative">Conservative</option>
            <option value="Balanced">Balanced</option>
            <option value="Aggressive">Aggressive</option>
            <option value="Very Aggressive">Very Aggressive</option>
        </select>
        <a href="{{ url_for('logout') }}"
            style="color:var(--accent); text-decoration:none; font-weight:bold; margin-left:15px;">Logout</a>
    </div>
</nav>

<div class="container">
    <!-- 1. ETAT DU PORTEFEUILLE -->
    <div class="grid-4" id="portfolio-panel">
        <div class="stat-box">
            <div class="stat-label">Total Portfolio</div>
            <div class="stat-value" id="val-total">${{ "%.2f"|format(portfolio_val) if portfolio_val != None else "0.00"
                }}</div>
            <div style="font-size:0.85rem; color:#888;">Cash: <span id="val-cash" style="color:#fff;">${{
                    "%.2f"|format(cash) if cash != None else "0.00" }}</span></div>
        </div>
        <div class="stat-box">
            <div class="stat-label">High Water Mark (HWM)</div>
            <div class="stat-value" id="val-hwm">${{ "%.2f"|format(hwm) if hwm != None else "0.00" }}</div>
            <div style="font-size:0.85rem;" id="val-hwm-pct">Depuis HWM:
                <span class="{{ 'text-red' if hwm_pct < 0 else 'text-green' }}">{{ "+" if hwm_pct > 0 else "" }}{{
                    "%.2f"|format(hwm_pct) if hwm_pct != None else "0.00" }}%</span>
            </div>
        </div>
        <div class="stat-box">
            <div class="stat-label">PnL du Jour</div>
            <div class="stat-value" id="val-pnl-today">
                <span class="{{ 'text-red' if pnl_today < 0 else 'text-green' }}">{{ "+" if pnl_today > 0 else "" }}${{
                    "%.2f"|format(pnl_today|abs) if pnl_today != None else "0.00" }}</span>
            </div>
            <div style="font-size:0.85rem;" id="val-pnl-week">
                <span class="{{ 'text-red' if pnl_week < 0 else 'text-green' }}">{{ "+" if pnl_week > 0 else "" }}${{
                    "%.2f"|format(pnl_week|abs) if pnl_week != None else "0.00" }}</span> sur 7j
            </div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Total PnL</div>
            <div class="stat-value" id="val-pnl-total">
                <span class="{{ 'text-red' if total_pnl < 0 else 'text-green' }}">{{ "+" if total_pnl > 0 else "" }}${{
                    "%.2f"|format(total_pnl|abs) if total_pnl != None else "0.00" }}</span>
            </div>
            <div style="font-size:0.85rem; color:#888;">Win Rate: <span id="val-winrate" class="text-accent">--</span>
            </div>
        </div>
    </div>

    <!-- MAIN CHART -->
    <div class="card">
        <h3 class="card-title">Performance Cumul√©e</h3>
        <div id="pnl-chart" style="height: 350px;"></div>
    </div>

    <!-- 2. POSITIONS EN COURS -->
    <div class="card">
        <h3 class="card-title">Positions en cours <span class="badge badge-gray" id="pos-count">{{ positions|length
                }}</span></h3>
        <div style="overflow-x: auto;">
            <table id="positions-table">
                <thead>
                    <tr>
                        <th>March√©</th>
                        <th>Token</th>
                        <th>Qty</th>
                        <th>Avg Price</th>
                        <th>Current Mid</th>
                        <th>Valeur</th>
                        <th>P&L</th>
                        <th>Skew</th>
                        <th>√Çge (J)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% if positions %}
                    {% for p in positions %}
                    <tr>
                        <td title="{{ p.market }}">{{ p.market }}</td>
                        <td><span class="badge badge-gray">{{ p.token_id }}</span></td>
                        <td>{{ "%.2f"|format(p.qty) }}</td>
                        <td>${{ "%.3f"|format(p.avg_price) }}</td>
                        <td>${{ "%.3f"|format(p.current_mid) }}</td>
                        <td>${{ "%.2f"|format(p.value) }}</td>
                        <td>
                            <span class="{{ 'text-red' if p.pnl_usd < 0 else 'text-green' }}">
                                {{ "+" if p.pnl_usd > 0 else "" }}${{ "%.2f"|format(p.pnl_usd|abs) }}
                            </span>
                            (
                            <span class="{{ 'text-red' if p.pnl_pct < 0 else 'text-green' }}">
                                {{ "+" if p.pnl_pct > 0 else "" }}{{ "%.2f"|format(p.pnl_pct|abs) }}%
                            </span>
                            )
                        </td>
                        <td>{{ "%.1f"|format(p.skew) }}%</td>
                        <td>{{ p.age_days }} j</td>
                        <td><button class="btn btn-outline" style="padding: 4px 8px; font-size:0.75rem;"
                                onclick="rebalanceToken('{{ p.raw_token_id }}')">Rebalance</button></td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="10" style="text-align:center;">Inventaire vide</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="grid-2">
        <!-- 3. HISTORIQUE DES TRADES -->
        <div class="card">
            <h3 class="card-title">
                Historique des Trades
                <select id="trade-filter" class="btn btn-outline" onchange="loadTrades(this.value)"
                    style="padding: 4px 8px; font-size: 0.8rem;">
                    <option value="50">50 derniers</option>
                    <option value="150">150 derniers</option>
                    <option value="500">500 derniers</option>
                </select>
            </h3>
            <div style="max-height: 400px; overflow-y: auto;">
                <table id="trades-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>March√©</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Prix Open</th>
                            <th>Prix Close</th>
                            <th>P&L</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 4. ANALYSE AUTO-CRITIQUE STRAT√âGIE -->
        <div class="card">
            <h3 class="card-title">AI Strategy Review</h3>
            <div id="ai-stats"
                style="margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; font-size: 0.9rem;">
                <!-- Stats inject√©es ici -->
            </div>

            <div id="ai-recs">
                <div style="text-align:center; padding: 20px; color:#888;">Analyse en cours...</div>
            </div>

            <button class="btn"
                style="width: 100%; margin-top: 15px; margin-bottom: 10px; background: linear-gradient(90deg, #d53369 0%, #daae51 100%); color: #fff; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(213, 51, 105, 0.4);"
                onclick="applyAllAiRecs()">üöÄ Appliquer TOUTES les recommandations AI en 1 clic</button>

            <button class="btn btn-outline" style="width: 100%; margin-top: 5px;" onclick="loadAIReview()">üîÑ Relancer
                l'Analyse</button>
        </div>
    </div>
</div>

<script>
    const layoutConfig = {
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { color: '#e0e0e0', family: "'Segoe UI', sans-serif" },
        margin: { t: 10, r: 10, l: 40, b: 30 },
        height: 350
    };

    function formatUsd(val) {
        if (val === undefined || val === null) return "--";
        const v = parseFloat(val);
        const prefix = v < 0 ? "-" : (v > 0 ? "+" : "");
        return `<span class="${v < 0 ? 'text-red' : (v > 0 ? 'text-green' : '')}">${prefix}$${Math.abs(v).toFixed(2)}</span>`;
    }
    function formatPct(val) {
        if (val === undefined || val === null) return "--";
        const v = parseFloat(val);
        const prefix = v < 0 ? "" : "+";
        return `<span class="${v < 0 ? 'text-red' : (v > 0 ? 'text-green' : '')}">${prefix}${v.toFixed(2)}%</span>`;
    }

    // 1. Portfolio & Kill Switch Fetching
    function loadPortfolio() {
        fetch('/api/v73/portfolio').then(r => r.json()).then(d => {
            document.getElementById('val-total').innerHTML = `$${d.total_value.toFixed(2)}`;
            document.getElementById('val-cash').innerHTML = `$${d.cash.toFixed(2)}`;
            document.getElementById('val-hwm').innerHTML = `$${d.hwm.toFixed(2)}`;
            document.getElementById('val-hwm-pct').innerHTML = `Depuis HWM: ${formatPct(d.hwm_pct)}`;
            document.getElementById('val-pnl-today').innerHTML = formatUsd(d.pnl_today);
            document.getElementById('val-pnl-week').innerHTML = `${formatUsd(d.pnl_week)} sur 7j`;
            document.getElementById('val-pnl-total').innerHTML = formatUsd(d.pnl_total);
        });

        // Kill Switch Status (re-used from old logic)
        fetch('/health').then(r => r.json()).then(d => {
            if (d.kill_switch) {
                document.getElementById('btn-kill').style.display = 'none';
                document.getElementById('btn-resume').style.display = 'inline-block';
            } else {
                document.getElementById('btn-kill').style.display = 'inline-block';
                document.getElementById('btn-resume').style.display = 'none';
            }
        });

        // Aggressivity DB status
        fetch('/api/aggressivity').then(r => r.json()).then(d => {
            document.getElementById('agg-indicator').innerText = `Level: ${d.level}`;
            document.getElementById('agg-select').value = d.level;
        });
    }

    // 2. Positions Table
    function loadPositions() {
        fetch('/api/v73/positions').then(r => r.json()).then(data => {
            document.getElementById('pos-count').innerText = data.length;
            const tbody = document.querySelector('#positions-table tbody');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#888;">Inventaire vide</td></tr>';
                return;
            }
            // Sort by PnL desc
            data.sort((a, b) => b.pnl_usd - a.pnl_usd);
            data.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td title="${p.market}">${p.market}</td>
                        <td><span class="badge badge-gray">${p.token_id}</span></td>
                        <td>${p.qty.toFixed(2)}</td>
                        <td>$${p.avg_price.toFixed(3)}</td>
                        <td>$${p.current_mid.toFixed(3)}</td>
                        <td>$${p.value.toFixed(2)}</td>
                        <td>${formatUsd(p.pnl_usd)} (${formatPct(p.pnl_pct)})</td>
                        <td>${p.skew.toFixed(1)}%</td>
                        <td>${p.age_days} j</td>
                        <td><button class="btn btn-outline" style="padding: 4px 8px; font-size:0.75rem;" onclick="rebalanceToken('${p.raw_token_id}')">Rebalance</button></td>
                    </tr>
                `;
            });
        });
    }

    // 3. Trades History & Chart
    function loadTrades(limit = 50) {
        fetch(`/api/v73/trades?limit=${limit}`).then(r => r.json()).then(data => {
            if (data.stats && data.stats.win_rate) {
                document.getElementById('val-winrate').innerText = `${data.stats.win_rate.toFixed(1)}%`;
            }

            const tbody = document.querySelector('#trades-table tbody');
            tbody.innerHTML = '';
            data.trades.forEach(t => {
                const date = new Date(t.close_timestamp || t.open_timestamp).toLocaleString('fr-FR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                tbody.innerHTML += `
                    <tr>
                        <td style="color:#888; font-size:0.8rem;">${date}</td>
                        <td title="${t.question}">${(t.question || "").substring(0, 30)}...</td>
                        <td><span class="${t.open_size > 0 ? 'text-accent' : ''}">BUY</span> &rarr; SELL</td>
                        <td>${t.open_size.toFixed(1)}</td>
                        <td>$${t.open_price.toFixed(3)}</td>
                        <td>$${(t.close_price || 0).toFixed(3)}</td>
                        <td>${formatUsd(t.pnl_usdc)}</td>
                    </tr>
                `;
            });
        });

        // Cumul PNL Chart (using existing endpoint)
        fetch('/api/analytics/cumulative-pnl').then(r => r.json()).then(data => {
            const traces = [{
                x: data.map(d => d.timestamp),
                y: data.map(d => d.pnl),
                type: 'scatter',
                mode: 'lines',
                line: { color: '#bb86fc', width: 3 },
                fill: 'tozeroy',
                fillcolor: 'rgba(187,134,252,0.1)'
            }];
            Plotly.newPlot('pnl-chart', traces, layoutConfig);
        });
    }

    // 4. AI Strategy Review
    function loadAIReview() {
        document.getElementById('ai-recs').innerHTML = '<div style="text-align:center; padding: 20px; color:#888;">Analyse AI en cours...</div>';
        fetch('/api/v73/trades?limit=1').then(r => r.json()).then(td => {
            const s = td.stats || {};
            let pfHtml = `<div class="grid-2" style="gap:10px;">`;
            pfHtml += `<div><strong>Sharpe Ratio:</strong> ${s.sharpe_ratio !== undefined ? s.sharpe_ratio.toFixed(2) : '--'}</div>`;
            pfHtml += `<div><strong>Max DD:</strong> ${s.max_drawdown_pct !== undefined ? s.max_drawdown_pct.toFixed(2) : '--'}%</div>`;
            pfHtml += `<div><strong>Win Rate:</strong> ${s.win_rate !== undefined ? s.win_rate.toFixed(1) : '--'}%</div>`;
            pfHtml += `<div><strong>Expectancy:</strong> $${s.expectancy !== undefined ? s.expectancy.toFixed(3) : '--'}</div>`;
            pfHtml += `</div>`;
            document.getElementById('ai-stats').innerHTML = pfHtml;
        });

        fetch('/api/v73/ai-review').then(r => r.json()).then(data => {
            const recCont = document.getElementById('ai-recs');
            recCont.innerHTML = '';
            if (!data.recommendations || data.recommendations.length === 0) {
                recCont.innerHTML = '<div style="color:#888;">Aucune recommandation disponible. Laissez le bot accumuler des trades.</div>';
                return;
            }

            data.recommendations.forEach(r => {
                let color = "#888";
                if (r.direction === "augmenter") color = "var(--green)";
                if (r.direction === "reduire") color = "var(--red)";

                recCont.innerHTML += `
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${color};">
                        <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                            <strong style="color:var(--text-color);">${r.parameter}</strong>
                            <span class="badge badge-gray">${r.direction.toUpperCase()}</span>
                        </div>
                        <div style="font-size: 0.85rem; color:#aaa; margin-bottom: 10px;">
                            Actuel: ${r.current_value} &rarr; Recommand√©: <strong style="color:${color}">${r.recommended_value}</strong>
                        </div>
                        <div style="font-size: 0.85rem; margin-bottom: 10px;">${r.reasoning}</div>
                        ${r.direction !== 'maintenir' && r.current_value !== r.recommended_value && r.recommended_value !== null ?
                        `<button class="btn btn-outline" style="font-size: 0.75rem; padding: 4px 8px;" onclick="applyAiRec('${r.parameter}', ${r.recommended_value})">Appliquer & Restart Bot (Live)</button>`
                        : ''}
                    </div>
                `;
            });
        });
    }

    // Actions
    function toggleBot(action) {
        fetch('/' + action, { method: 'POST' }).then(() => {
            setTimeout(loadPortfolio, 500);
        });
    }

    function setAggressivity(level) {
        const indicator = document.getElementById('agg-indicator');
        indicator.innerText = "‚è≥ Applying...";
        indicator.style.background = "#555";
        fetch('/api/aggressivity', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ level: level })
        }).then(r => r.json()).then(data => {
            if (data.status === "ok") {
                indicator.innerText = "‚úÖ " + data.level;
                indicator.style.background = "#1b5e20";
                // Show toast
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#1b5e20,#2e7d32);color:#fff;padding:14px 24px;border-radius:10px;z-index:9999;font-weight:bold;box-shadow:0 4px 20px rgba(0,0,0,0.4);animation:fadeIn 0.3s;';
                toast.innerHTML = `üéØ Agressivit√© ‚Üí <strong>${data.level}</strong><br><small>Bot recharg√© au prochain cycle</small>`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
                setTimeout(loadPortfolio, 500);
            } else {
                indicator.innerText = "‚ùå Erreur";
                indicator.style.background = "#b71c1c";
            }
            // Reset badge color after 3s
            setTimeout(() => { indicator.style.background = "#333"; }, 3000);
        }).catch(() => {
            indicator.innerText = "‚ùå Erreur r√©seau";
            indicator.style.background = "#b71c1c";
            setTimeout(() => { indicator.style.background = "#333"; }, 3000);
        });
    }

    function rebalanceToken(token) {
        if (confirm("Forcer le bot √† ex√©cuter un market SELL de 50% sur ce token au prochain cycle ?")) {
            fetch('/api/v73/rebalance/' + token, { method: 'POST' }).then(r => r.json()).then(d => {
                alert("Ordre de rebalance envoy√©. Surveillez les logs.");
            });
        }
    }

    function applyAiRec(param, val) {
        if (confirm(`Appliquer la recommandation AI pour ${param} = ${val} et red√©marrer le bot ?`)) {
            fetch('/api/v73/apply-rec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ parameter: param, value: val })
            }).then(() => {
                alert("Param√®tre sauvegard√© dans config.yaml. Le bot est en cours de red√©marrage et le mode Agressivit√© est pass√© en Custom.");
                setTimeout(loadPortfolio, 1000);
            });
        }
    }

    function applyAllAiRecs() {
        if (confirm("üöÄ √ätes-vous s√ªr de vouloir appliquer TOUTES les recommandations AI recommand√©es (sauf celles √† maintenir) et red√©marrer le bot ?")) {
            fetch('/api/v73/apply-all-recs', {
                method: 'POST'
            }).then(r => r.json()).then(data => {
                if (data.status === "ok") {
                    alert(`‚úÖ ${data.applied_count} recommandations appliqu√©es avec succ√®s. Le bot red√©marre et le mode Agressivit√© est pass√© en Custom.`);
                    setTimeout(loadPortfolio, 1000);
                } else {
                    alert("Erreur lors de l'application des recommandations: " + data.error);
                }
            }).catch(e => {
                alert("Erreur r√©seau ou d'ex√©cution.");
            });
        }
    }

    function exportCSV() {
        // Redirection vers CSV old endpoint as fallback logic or basic redirect
        alert("Using external CSV exporter from previous dashboard iteration logic (mock).");
    }

    // Init All
    function initDashboard() {
        loadPortfolio();
        loadPositions();
        loadTrades(50);
        loadAIReview();
    }

    initDashboard();

    // Live update every 15 seconds
    setInterval(() => {
        loadPortfolio();
        loadPositions();
    }, 15000);
</script>
{% endblock %}