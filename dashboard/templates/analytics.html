{% extends "base.html" %}
{% block title %}Analytics – Polymarket Bot{% endblock %}

{% block body %}
<!-- ── Navbar ─────────────────────────────────────────────── -->
<nav class="navbar">
    <span class="navbar-brand">Polymarket Bot</span>
    <div class="navbar-links">
        <div id="kill-badge"
             hx-get="/api/kill-status"
             hx-trigger="load, every 5s"
             hx-swap="innerHTML">
        </div>
        <a href="{{ url_for('index') }}">Dashboard</a>
        <a href="{{ url_for('analytics_page') }}" style="font-weight:600; color:var(--accent);">Analytics</a>
        <a href="{{ url_for('logout') }}">Logout</a>
    </div>
</nav>

<div class="container">

    <!-- ── Tabs ────────────────────────────────────────────── -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="performance">Performance</button>
        <button class="tab-btn" data-tab="markets">Marches</button>
        <button class="tab-btn" data-tab="params">Parametres</button>
    </div>

    <!-- ════════════════════════════════════════════════════════
         TAB 1 : PERFORMANCE
         ════════════════════════════════════════════════════════ -->
    <div class="tab-content active" id="tab-performance">

        <!-- KPI Cards -->
        <div class="grid-4" id="kpi-cards">
            <div class="card kpi"><div class="stat-value">--</div><div class="stat-label">PnL Total</div></div>
            <div class="card kpi"><div class="stat-value">--</div><div class="stat-label">Win Rate</div></div>
            <div class="card kpi"><div class="stat-value">--</div><div class="stat-label">Sharpe Ratio</div></div>
            <div class="card kpi"><div class="stat-value">--</div><div class="stat-label">Max Drawdown</div></div>
        </div>

        <!-- Extra KPI row -->
        <div class="grid-4" id="kpi-cards-2" style="display:none;">
            <div class="card kpi"><div class="stat-value" id="kpi-trades">--</div><div class="stat-label">Trades</div></div>
            <div class="card kpi"><div class="stat-value" id="kpi-expectancy">--</div><div class="stat-label">Expectancy</div></div>
            <div class="card kpi"><div class="stat-value" id="kpi-profit-factor">--</div><div class="stat-label">Profit Factor</div></div>
            <div class="card kpi"><div class="stat-value" id="kpi-avg-hold">--</div><div class="stat-label">Duree moy.</div></div>
        </div>

        <!-- Equity Curve -->
        <div class="card">
            <div class="card-header"><span class="card-title">Equity Curve</span></div>
            <canvas id="chart-equity" height="250"></canvas>
        </div>

        <!-- Cumulative PnL -->
        <div class="card">
            <div class="card-header"><span class="card-title">PnL Cumule (par trade)</span></div>
            <canvas id="chart-cum-pnl" height="220"></canvas>
        </div>

        <!-- Daily PnL -->
        <div class="card">
            <div class="card-header"><span class="card-title">PnL Journalier</span></div>
            <canvas id="chart-daily-pnl" height="200"></canvas>
        </div>
    </div>

    <!-- ════════════════════════════════════════════════════════
         TAB 2 : MARCHES
         ════════════════════════════════════════════════════════ -->
    <div class="tab-content" id="tab-markets">

        <!-- PnL par marche -->
        <div class="card">
            <div class="card-header"><span class="card-title">PnL par Marche (Top 10)</span></div>
            <canvas id="chart-by-market" height="300"></canvas>
        </div>

        <div class="grid-2">
            <!-- Win Rate par regime -->
            <div class="card">
                <div class="card-header"><span class="card-title">Win Rate par Regime OBI</span></div>
                <canvas id="chart-by-regime" height="250"></canvas>
            </div>

            <!-- PnL par bucket OBI -->
            <div class="card">
                <div class="card-header"><span class="card-title">PnL par Tranche OBI</span></div>
                <canvas id="chart-by-obi" height="250"></canvas>
            </div>
        </div>

        <!-- Tableau top marches -->
        <div class="card">
            <div class="card-header"><span class="card-title">Tableau des Marches</span></div>
            <div class="table-wrap" id="markets-table">
                <table><thead><tr><th colspan="6" style="text-align:center; color:var(--text-dim);">Chargement...</th></tr></thead></table>
            </div>
        </div>
    </div>

    <!-- ════════════════════════════════════════════════════════
         TAB 3 : PARAMETRES (RECOMMANDATIONS)
         ════════════════════════════════════════════════════════ -->
    <div class="tab-content" id="tab-params">

        <!-- Bouton backfill -->
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:0.9rem; color:var(--text-dim);">
                Reconstruire les trades a partir de l'historique des ordres
            </span>
            <button class="btn" id="btn-backfill" onclick="runBackfill()">Backfill trades</button>
        </div>

        <!-- Tableau recommandations -->
        <div class="card">
            <div class="card-header"><span class="card-title">Recommandations de Parametres</span></div>
            <div class="table-wrap" id="reco-table">
                <table><thead><tr><th colspan="5" style="text-align:center; color:var(--text-dim);">Chargement...</th></tr></thead></table>
            </div>
        </div>

        <!-- Detail par recommandation -->
        <div id="reco-details"></div>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
    .tabs { display:flex; gap:4px; margin-bottom:20px; }
    .tab-btn {
        padding:10px 20px; border:1px solid var(--border); border-radius:var(--radius);
        background:var(--surface); color:var(--text-dim); font-size:0.85rem; font-weight:600;
        cursor:pointer; transition:all 0.15s;
    }
    .tab-btn:hover { background:var(--surface-hover); color:var(--text); }
    .tab-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .grid-4 {
        display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
        gap:16px; margin-bottom:20px;
    }
    .grid-2 {
        display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
        gap:16px; margin-bottom:20px;
    }
    .kpi { text-align:center; }
    .confidence-bar {
        height:6px; border-radius:3px; background:var(--border); overflow:hidden; width:80px; display:inline-block;
    }
    .confidence-fill { height:100%; border-radius:3px; }
    .reco-card { margin-bottom:12px; }
    .reco-reasoning {
        font-size:0.82rem; color:var(--text-dim); padding:12px; background:var(--bg);
        border-radius:var(--radius); margin-top:8px; line-height:1.5;
    }
    .direction-augmenter { color:var(--green); }
    .direction-reduire { color:var(--red); }
    .direction-maintenir { color:var(--orange); }
    .direction-attendre { color:var(--text-dim); }
</style>

<script>
// ── Utilitaires ───────────────────────────────────────────────
const chartDefaults = {
    color: '#8b8fa3',
    borderColor: '#2a2e3d',
    font: { family: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif" }
};
Chart.defaults.color = chartDefaults.color;
Chart.defaults.borderColor = chartDefaults.borderColor;

function fmt$(v) { return v >= 0 ? `+$${v.toFixed(2)}` : `-$${Math.abs(v).toFixed(2)}`; }
function fmtPct(v) { return v.toFixed(1) + '%'; }

// ── Tabs ──────────────────────────────────────────────────────
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
});

// ── Charts storage ────────────────────────────────────────────
let charts = {};

function destroyChart(id) {
    if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

// ── Load KPIs ─────────────────────────────────────────────────
async function loadSummary() {
    try {
        const resp = await fetch('/api/analytics/summary');
        const d = await resp.json();
        const pnlClass = d.total_pnl >= 0 ? 'text-green' : 'text-red';
        const wrClass = d.win_rate >= 50 ? 'text-green' : 'text-red';
        document.getElementById('kpi-cards').innerHTML = `
            <div class="card kpi"><div class="stat-value ${pnlClass}">${fmt$(d.total_pnl)}</div><div class="stat-label">PnL Total</div></div>
            <div class="card kpi"><div class="stat-value ${wrClass}">${fmtPct(d.win_rate)}</div><div class="stat-label">Win Rate (${d.total_trades} trades)</div></div>
            <div class="card kpi"><div class="stat-value">${d.sharpe_ratio.toFixed(2)}</div><div class="stat-label">Sharpe Ratio</div></div>
            <div class="card kpi"><div class="stat-value text-red">-${d.max_drawdown_pct.toFixed(1)}%</div><div class="stat-label">Max Drawdown</div></div>
        `;
        // Extra row
        const avgHold = d.avg_hold_duration > 3600
            ? (d.avg_hold_duration / 3600).toFixed(1) + 'h'
            : (d.avg_hold_duration / 60).toFixed(0) + 'min';
        const pfStr = d.profit_factor === Infinity ? '∞' : d.profit_factor.toFixed(2);
        document.getElementById('kpi-cards-2').style.display = 'grid';
        document.getElementById('kpi-trades').textContent = `${d.total_trades} / ${d.open_trades}`;
        document.getElementById('kpi-expectancy').textContent = fmt$(d.expectancy);
        document.getElementById('kpi-profit-factor').textContent = pfStr;
        document.getElementById('kpi-avg-hold').textContent = avgHold;
    } catch(e) { console.error('Summary error:', e); }
}

// ── Equity Curve ──────────────────────────────────────────────
async function loadEquityCurve() {
    try {
        const resp = await fetch('/api/analytics/equity-curve');
        const data = await resp.json();
        if (!data.length) return;
        destroyChart('equity');
        const ctx = document.getElementById('chart-equity').getContext('2d');
        charts['equity'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.timestamp.substring(5, 16).replace('T',' ')),
                datasets: [{
                    label: 'Balance (USDC)',
                    data: data.map(d => d.balance),
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99,102,241,0.1)',
                    fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2,
                }]
            },
            options: { responsive:true, scales: { x: { display:true, ticks:{maxTicksLimit:10} } } }
        });
    } catch(e) { console.error('Equity curve error:', e); }
}

// ── Cumulative PnL ────────────────────────────────────────────
async function loadCumulativePnl() {
    try {
        const resp = await fetch('/api/analytics/cumulative-pnl');
        const data = await resp.json();
        if (!data.length) return;
        destroyChart('cumPnl');
        const ctx = document.getElementById('chart-cum-pnl').getContext('2d');
        charts['cumPnl'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => '#' + d.trade_num),
                datasets: [{
                    label: 'PnL Cumule ($)',
                    data: data.map(d => d.cumulative_pnl),
                    borderColor: data[data.length-1].cumulative_pnl >= 0 ? '#22c55e' : '#ef4444',
                    backgroundColor: 'rgba(34,197,94,0.08)',
                    fill: true, tension: 0.3, pointRadius: 1, borderWidth: 2,
                }]
            },
            options: { responsive:true, scales: { x: { ticks:{maxTicksLimit:15} } } }
        });
    } catch(e) { console.error('Cumulative PnL error:', e); }
}

// ── Daily PnL ─────────────────────────────────────────────────
async function loadDailyPnl() {
    try {
        const resp = await fetch('/api/analytics/daily-pnl');
        const data = await resp.json();
        if (!data.length) return;
        destroyChart('dailyPnl');
        const ctx = document.getElementById('chart-daily-pnl').getContext('2d');
        charts['dailyPnl'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.date),
                datasets: [{
                    label: 'PnL ($)',
                    data: data.map(d => d.pnl),
                    backgroundColor: data.map(d => d.pnl >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)'),
                    borderRadius: 4,
                }]
            },
            options: { responsive:true }
        });
    } catch(e) { console.error('Daily PnL error:', e); }
}

// ── By Market ─────────────────────────────────────────────────
async function loadByMarket() {
    try {
        const resp = await fetch('/api/analytics/by-market');
        const data = await resp.json();
        if (!data.length) return;
        const top10 = data.slice(0, 10);
        destroyChart('byMarket');
        const ctx = document.getElementById('chart-by-market').getContext('2d');
        charts['byMarket'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top10.map(d => (d.question || '').substring(0, 30) + '...'),
                datasets: [{
                    label: 'PnL ($)',
                    data: top10.map(d => d.total_pnl),
                    backgroundColor: top10.map(d => d.total_pnl >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)'),
                    borderRadius: 4,
                }]
            },
            options: { responsive:true, indexAxis:'y' }
        });

        // Tableau
        let rows = top10.map(d => {
            const wrClass = d.win_rate >= 50 ? 'text-green' : 'text-red';
            const pnlClass = d.total_pnl >= 0 ? 'text-green' : 'text-red';
            return `<tr>
                <td title="${(d.question||'').replace(/"/g,'&quot;')}">${(d.question||'').substring(0,35)}...</td>
                <td>${d.trades}</td>
                <td class="${wrClass}">${d.win_rate.toFixed(0)}%</td>
                <td class="${pnlClass}">${fmt$(d.total_pnl)}</td>
                <td>${d.avg_hold ? Math.round(d.avg_hold/60) + 'min' : 'N/A'}</td>
            </tr>`;
        }).join('');
        document.getElementById('markets-table').innerHTML = `
            <table>
                <thead><tr><th>Question</th><th>Trades</th><th>Win%</th><th>PnL</th><th>Duree</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>`;
    } catch(e) { console.error('By market error:', e); }
}

// ── By Regime ─────────────────────────────────────────────────
async function loadByRegime() {
    try {
        const resp = await fetch('/api/analytics/by-regime');
        const data = await resp.json();
        if (!data.length) return;
        destroyChart('byRegime');
        const ctx = document.getElementById('chart-by-regime').getContext('2d');
        const colors = { bullish:'#22c55e', bearish:'#ef4444', neutral:'#f59e0b', unknown:'#8b8fa3' };
        charts['byRegime'] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => `${d.regime} (${d.win_rate.toFixed(0)}%)`),
                datasets: [{
                    data: data.map(d => d.trades),
                    backgroundColor: data.map(d => colors[d.regime] || colors.unknown),
                }]
            },
            options: { responsive:true, plugins: { legend: { position:'bottom' } } }
        });
    } catch(e) { console.error('By regime error:', e); }
}

// ── By OBI Bucket ─────────────────────────────────────────────
async function loadByObiBucket() {
    try {
        const resp = await fetch('/api/analytics/by-obi-bucket');
        const data = await resp.json();
        if (!data.length) return;
        destroyChart('byObi');
        const ctx = document.getElementById('chart-by-obi').getContext('2d');
        charts['byObi'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.bucket),
                datasets: [{
                    label: 'Avg PnL ($)',
                    data: data.map(d => d.avg_pnl),
                    backgroundColor: data.map(d => d.avg_pnl >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)'),
                    borderRadius: 4,
                }, {
                    label: 'Trades',
                    data: data.map(d => d.trades),
                    type: 'line',
                    borderColor: '#6366f1',
                    yAxisID: 'y1',
                    pointRadius: 3,
                    borderWidth: 2,
                }]
            },
            options: {
                responsive:true,
                scales: {
                    y: { title: { display:true, text:'Avg PnL ($)' } },
                    y1: { position:'right', title: { display:true, text:'Trades' }, grid:{drawOnChartArea:false} }
                }
            }
        });
    } catch(e) { console.error('By OBI error:', e); }
}

// ── Recommendations ───────────────────────────────────────────
async function loadRecommendations() {
    try {
        const resp = await fetch('/api/analytics/recommendations');
        const data = await resp.json();
        if (!data.length) {
            document.getElementById('reco-table').innerHTML = '<p style="color:var(--text-dim); padding:12px;">Aucune recommandation disponible.</p>';
            return;
        }

        let rows = data.map((r, i) => {
            const dirClass = 'direction-' + r.direction;
            const confPct = Math.round((r.confidence || 0) * 100);
            const confColor = confPct >= 70 ? '#22c55e' : confPct >= 40 ? '#f59e0b' : '#ef4444';
            const currentStr = r.current_value !== null ? r.current_value : '--';
            const recoStr = r.recommended_value !== null ? r.recommended_value : '--';
            return `<tr onclick="toggleReco(${i})" style="cursor:pointer;">
                <td><strong>${r.parameter}</strong></td>
                <td>${currentStr}</td>
                <td>${recoStr}</td>
                <td><span class="confidence-bar"><span class="confidence-fill" style="width:${confPct}%; background:${confColor};"></span></span> ${confPct}%</td>
                <td class="${dirClass}">${r.direction.toUpperCase()}</td>
            </tr>`;
        }).join('');

        document.getElementById('reco-table').innerHTML = `
            <table>
                <thead><tr><th>Parametre</th><th>Actuel</th><th>Suggere</th><th>Confiance</th><th>Direction</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>`;

        // Details
        let details = data.map((r, i) => `
            <div class="card reco-card" id="reco-detail-${i}" style="display:none;">
                <div class="card-header"><span class="card-title">${r.parameter}</span></div>
                <div class="reco-reasoning">${r.reasoning}</div>
            </div>
        `).join('');
        document.getElementById('reco-details').innerHTML = details;

        window._recoData = data;
    } catch(e) { console.error('Recommendations error:', e); }
}

function toggleReco(idx) {
    const el = document.getElementById('reco-detail-' + idx);
    if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

// ── Backfill ──────────────────────────────────────────────────
async function runBackfill() {
    const btn = document.getElementById('btn-backfill');
    btn.disabled = true;
    btn.textContent = 'En cours...';
    try {
        const resp = await fetch('/api/analytics/backfill', { method:'POST' });
        const data = await resp.json();
        btn.textContent = `${data.trades_created} trades crees`;
        // Reload data
        setTimeout(() => { loadAll(); btn.textContent = 'Backfill trades'; btn.disabled = false; }, 2000);
    } catch(e) {
        btn.textContent = 'Erreur';
        setTimeout(() => { btn.textContent = 'Backfill trades'; btn.disabled = false; }, 3000);
    }
}

// ── Load All ──────────────────────────────────────────────────
async function loadAll() {
    await Promise.all([
        loadSummary(),
        loadEquityCurve(),
        loadCumulativePnl(),
        loadDailyPnl(),
        loadByMarket(),
        loadByRegime(),
        loadByObiBucket(),
        loadRecommendations(),
    ]);
}

// Init
loadAll();
// Refresh every 60s
setInterval(loadAll, 60000);
</script>
{% endblock %}
