{% extends "base.html" %}

{% block content %}
<div class="mb-8 flex justify-between items-end">
    <div>
        <h1 class="text-3xl font-bold mb-2">Sniper Ops Center</h1>
        <p class="text-slate-400">Surveillance temps réel du momentum BTC et de l'Order Book Imbalance.</p>
    </div>
    <div class="text-right">
        <div class="text-sm text-slate-400 uppercase tracking-widest mb-1">High Water Mark</div>
        <div class="text-2xl font-mono text-sky-300">{{ "%.2f"|format(hwm) }} USDC</div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10 w-full max-w-4xl mx-auto">
    <!-- Momentum Card -->
    <div
        class="bg-cardbg rounded-2xl p-8 border border-slate-700 shadow-xl flex flex-col items-center justify-center text-center transition-transform hover:scale-[1.02]">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6">Binance Momentum (30s)</h3>
        <div id="mom-val"
            class="text-6xl font-black font-mono tracking-tighter transition-colors duration-300 text-slate-100">0.000%
        </div>
        <div class="mt-6 text-sm text-slate-500 bg-slate-800/50 py-1.5 px-4 rounded-full border border-slate-700">Seuil
            de tir : ±0.012%</div>
    </div>

    <!-- OBI Card -->
    <div
        class="bg-cardbg rounded-2xl p-8 border border-slate-700 shadow-xl flex flex-col items-center justify-center text-center transition-transform hover:scale-[1.02]">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6">Binance Order Book (OBI)</h3>
        <div id="obi-val"
            class="text-6xl font-black font-mono tracking-tighter transition-colors duration-300 text-slate-100">0.00
        </div>
        <div class="mt-6 text-sm text-slate-500 bg-slate-800/50 py-1.5 px-4 rounded-full border border-slate-700">Seuil
            de tir : ±0.12</div>
    </div>
</div>

<div class="flex justify-center">
    <div
        class="flex items-center text-sm font-medium text-slate-400 bg-cardbg px-6 py-3 rounded-full border border-slate-700 shadow-lg cursor-default">
        <div class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse mr-3 shadow-[0_0_8px_rgba(34,197,94,0.6)]">
        </div>
        Connecté au flux Binance WS &nbsp;&nbsp;|&nbsp;&nbsp; Mise à jour : <span id="last-update"
            class="ml-2 font-mono text-slate-300">...</span>
    </div>
</div>

<script>
    function updateColors(el, val, threshold) {
        el.classList.remove('text-green-400', 'text-red-400', 'text-slate-100');
        if (val >= threshold) el.classList.add('text-green-400');
        else if (val <= -threshold) el.classList.add('text-red-400');
        else el.classList.add('text-slate-100');
    }

    function fetchRadar() {
        fetch('/api/sniper-radar')
            .then(response => response.json())
            .then(data => {
                const momEl = document.getElementById('mom-val');
                const obiEl = document.getElementById('obi-val');

                // Update Momentum
                let momVal = data.momentum_30s;
                momEl.innerText = (momVal > 0 ? '+' : '') + momVal.toFixed(3) + '%';
                updateColors(momEl, momVal, 0.012);

                // Update OBI
                let obiVal = data.obi;
                obiEl.innerText = (obiVal > 0 ? '+' : '') + obiVal.toFixed(2);
                updateColors(obiEl, obiVal, 0.12);

                // Update Time
                document.getElementById('last-update').innerText = new Date().toLocaleTimeString('fr-FR');
            })
            .catch(err => console.error("Radar Error:", err));
    }

    // Rafraîchissement toutes les 2 secondes
    setInterval(fetchRadar, 2000);
    fetchRadar(); // Appel initial
</script>
{% endblock %}